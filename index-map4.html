<!DOCTYPE html>
<html ng-app="lbsApp" ng-controller="lbsCtrl">
	<head>
		<meta charset="UTF-8">
		<title>地图开发</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="static/css/ionic.css" />	
		<style>
		#framewrap{
			position: fixed;
			left:0;
			top:0;
			z-index: 1001;
			width: 100%;
			height: 800px;
			background-color: #fff;
		}
		</style>
	</head>
	<body>
		<div id="framewrap" ng-show="showIframe">
			<iframe src="" id="test" frameborder="0" height="800"></iframe>
		</div>
		<div class="bar bar-header">
			<button class="button button-clear button-assertive" ng-show="showIframe" ng-click="showIframe=false">&times;</button>
			<h1 class="title">地图选址</h1>
			
		</div>
		
		<ion-content class="has-header" on-scroll="checkPosition()">
		<div class="list">
			<div class="item item-input">
				<i class="icon ion-location placeholder-icon"
					ng-click="changeLocation()"					
					></i>
				<input type="text" ng-model="regeocode.formattedAddress"/>
				
			</div>
			<div class="item item-input">
				<label class="input-label text-right">选址省</label>
				<input type="text" ng-model="regeocode.addressComponent.province" />
			</div>
			<div class="item item-input">
				<label class="input-label text-right">选址市</label>
				<input type="text" ng-model="regeocode.addressComponent.city" />
			</div>
			<div class="item item-input">
				<label class="input-label text-right">选址区县</label>
				<input type="text" ng-model="regeocode.addressComponent.district" />
			</div>
			<div class="item item-input">
				<label class="input-label text-right">选址街道</label>
				<input type="text" ng-model="regeocode.addressComponent.township" />
			</div>
			<div class="item item-input">
				<button class="button button-assertive" ng-click="showFood()">周边美食</button>
			</div>
			<div class="item item-divider">打车</div>
			<div class="item item-input">
				<label class="input-label">当前位置</label>
				<i class="icon ion-location placeholder-icon"
					ng-click="changeLocation()"					
					></i>
				<input type="text" ng-model="regeocode.formattedAddress"/>
				
			</div>
			<div class="item item-input">
				<label class="input-label">到哪里去</label>
				<i class="icon ion-location placeholder-icon"
					ng-click="changeLocation2()"					
					></i>
				<input type="text" ng-model="regeocode.formattedAddress2"/>
				
			</div>
			<div class="item ">
				<button class="button button-positive" ng-click="showRoad()">打车</button>
			</div>
			
			
		</div>
		
			
		</ion-content>
		<script src="http://webapi.amap.com/maps?v=1.3&key=5efbda3075d474c2aa578775121667f0"></script>
		<script src="lib/ionic.bundle.min.js"></script>	
		<script>
			angular.module("lbsApp",["ionic"])
			.controller("lbsCtrl",["$scope",function($scope){
				$scope.showIframe=false;
				$scope.regeocode={};
				
				$scope.regeocode.formattedAddress="正在定位中";
				
				$scope.lonlat=[];
//				获取当前的经纬度
				navigator.geolocation.getCurrentPosition(function(location){
					
					$scope.$apply(function(){							
						$scope.lonlat=location.coords.longitude+","+location.coords.latitude;
					});
					AMap.plugin('AMap.Geocoder',function(){
       					var geocoder = new AMap.Geocoder({});        				
        				geocoder.getAddress([location.coords.longitude,location.coords.latitude],function(status,result){
             				
             				if(status=='complete'){                					
                				   alert($scope.regeocode.formattedAddress);
                				   $scope.$apply(function(){                				 
                				   	$scope.regeocode=result.regeocode; 
                				   	
                				   })
                					  
                					 
                			
             				 }
            		}) //getAddress
				})// plgin ed
			})// getCurrentPosition ed
			$scope.changeLocation=function(){
				$scope.showIframe=true;
					(function(){
						var url="https://m.amap.com/picker/?keywords=写字楼,小区,学校&zoom=15&center="+$scope.lonlat+"&radius=1000&total=20&key=5efbda3075d474c2aa578775121667f0";					// 动态设置src 触发onload
						document.getElementById('framewrap').style.top="0px";
						document.getElementById('test').src=url;
						document.getElementById('test').setAttribute("width",window.innerWidth);
						document.getElementById('test').setAttribute("height",window.innerHeight);
					    var iframe = document.getElementById('test').contentWindow;
					    
					   
					    document.getElementById('test').onload = function(){
					    	// 发送一条信息给高德
					      iframe.postMessage('hello','https://m.amap.com/picker/');
					   
					    };
					    // 当单击高德里面的页面（iframe）
					    // 他给当前页面发送=数据
					    window.addEventListener("message", function(e){
					    	console.info(e.data);
					    	$scope.regeocode.formattedAddress=e.data.address+" "+e.data.name;
					    	$scope.lonlat=e.data.location;
					    	$scope.$apply(function(){
					    		$scope.showIframe=false;
					    	})
					    	
					    
					    
					     }, false);
					}())
			}
			
			$scope.showFood=function(){
			
				$scope.showIframe=true;
			
				var url="http://m.amap.com/around/?locations="+$scope.lonlat+"&keywords=美食,KTV,地铁站,公交站&defaultIndex=1&defaultView=&searchRadius=5000&key=5efbda3075d474c2aa578775121667f0";					// 动态设置src 触发onload
				document.getElementById('framewrap').style.top="45px";
				document.getElementById('test').src=url;
				document.getElementById('test').setAttribute("width",window.innerWidth);
				document.getElementById('test').setAttribute("height",window.innerHeight-45);
			}
			
			$scope.changeLocation2=function(){
				$scope.showIframe=true;
					(function(){
						var url="https://m.amap.com/picker/?keywords=写字楼,小区,学校&zoom=15&center="+$scope.lonlat+"&radius=1000&total=20&key=5efbda3075d474c2aa578775121667f0";					// 动态设置src 触发onload
						document.getElementById('framewrap').style.top="0px";
						document.getElementById('test').src=url;
						document.getElementById('test').setAttribute("width",window.innerWidth);
						document.getElementById('test').setAttribute("height",window.innerHeight);
					    var iframe = document.getElementById('test').contentWindow;
					    alert(iframe.offsetHeight);
					    
					   
					    document.getElementById('test').onload = function(){
					    	// 发送一条信息给高德
					      iframe.postMessage('hello','https://m.amap.com/picker/');
					   
					    };
					    // 当单击高德里面的页面（iframe）
					    // 他给当前页面发送=数据
					    window.addEventListener("message", function(e){
					    	console.info(e.data);
					    	$scope.regeocode.formattedAddress2=e.data.address+" "+e.data.name;
					    	$scope.lonlat2=e.data;
					    	$scope.$apply(function(){
					    		$scope.showIframe=false;
					    		$scope.showRoad();
					    	})	
					    	
					    
					    
					     }, false);
					}())
			}
			
			$scope.showRoad=function(){
				$scope.showIframe=true;
			
				var url="http://m.amap.com/navi/?start="+$scope.lonlat+"&dest="+$scope.lonlat2+"&destName=阜通西&naviBy=car&key=5efbda3075d474c2aa578775121667f0";					// 动态设置src 触发onload
				document.getElementById('framewrap').style.top="45px";
				document.getElementById('test').src=url;
				document.getElementById('test').setAttribute("width",window.innerWidth);
				document.getElementById('test').setAttribute("height",window.innerHeight-45);
				
				
			}
			
			
			}])
			
			
			
				
		</script>
	</body>
</html>
